<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Handler Simulator</title>
    <style>
        :root {
            --slack-bg: #1a1d21;
            --slack-secondary: #222529;
            --slack-hover: #27242c;
            --slack-border: #383838;
            --slack-text: #d1d2d3;
            --slack-text-muted: #9a9b9d;
            --slack-accent: #1264a3;
            --slack-link: #1d9bd1;
            --slack-green: #2bac76;
            --slack-yellow: #e8a300;
            --slack-red: #e01e5a;
            --slack-purple: #4a154b;
            --border-radius: 8px;
            --transition: all 0.15s ease;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Lato', 'Segoe UI', system-ui, sans-serif;
            background: var(--slack-bg);
            color: var(--slack-text);
            min-height: 100vh;
            font-size: 15px;
            line-height: 1.46668;
        }

        /* Header - Slack style */
        header {
            background: var(--slack-purple);
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--slack-border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.125rem;
            font-weight: 700;
            color: white;
        }

        .header-actions { display: flex; gap: 0.75rem; align-items: center; }

        /* Layout - Code on left, Output on right */
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr auto;
            height: calc(100vh - 52px);
        }

        .panel {
            background: var(--slack-secondary);
            border-right: 1px solid var(--slack-border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel:last-child { border-right: none; }

        .panel-header {
            padding: 0.75rem 1rem;
            background: var(--slack-bg);
            border-bottom: 1px solid var(--slack-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 700;
            font-size: 0.9375rem;
        }

        .panel-content {
            flex: 1;
            overflow: auto;
            padding: 0;
        }

        /* Code Editor Panel - Left side */
        .code-panel {
            grid-column: 1;
            grid-row: 1;
        }

        .code-panel .panel-content {
            display: flex;
            flex-direction: column;
        }

        .handler-select {
            display: flex;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: var(--slack-bg);
            border-bottom: 1px solid var(--slack-border);
        }

        select, input, textarea {
            background: var(--slack-bg);
            border: 1px solid var(--slack-border);
            border-radius: 4px;
            padding: 0.5rem 0.75rem;
            color: var(--slack-text);
            font-size: 0.875rem;
            transition: var(--transition);
        }

        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: var(--slack-accent);
            box-shadow: 0 0 0 1px var(--slack-accent);
        }

        select { flex: 1; cursor: pointer; }

        .code-editor {
            flex: 1;
            width: 100%;
            resize: none;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.5;
            padding: 1rem;
            background: #0d1117;
            border: none;
            border-radius: 0;
            color: #c9d1d9;
            tab-size: 2;
        }

        .code-editor:focus { box-shadow: none; }

        /* Output Panel - Right side */
        .output-panel {
            grid-column: 2;
            grid-row: 1;
            display: flex;
            flex-direction: column;
        }

        /* Message Composer - At top of output panel */
        .message-composer {
            padding: 1rem;
            background: var(--slack-bg);
            border-bottom: 1px solid var(--slack-border);
        }

        .composer-input {
            background: var(--slack-secondary);
            border: 1px solid var(--slack-border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            width: 100%;
            color: var(--slack-text);
            font-size: 0.9375rem;
            resize: none;
        }

        .composer-input:focus {
            border-color: var(--slack-text-muted);
        }

        .composer-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.5rem;
        }

        .composer-options {
            display: flex;
            gap: 0.25rem;
        }

        .composer-fields {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .field-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .field-group label {
            font-size: 0.75rem;
            color: var(--slack-text-muted);
            font-weight: 600;
        }

        .field-group input, .field-group select {
            padding: 0.375rem 0.5rem;
            font-size: 0.8125rem;
        }

        /* Output section with messages */
        .output-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .output-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-bottom: 1px solid var(--slack-border);
        }

        .section-header {
            padding: 0.5rem 1rem;
            background: var(--slack-bg);
            border-bottom: 1px solid var(--slack-border);
            font-weight: 700;
            font-size: 0.8125rem;
            color: var(--slack-text-muted);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Slack Messages */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem 0;
        }

        .slack-message {
            display: flex;
            padding: 0.5rem 1.25rem;
            gap: 0.75rem;
            transition: var(--transition);
        }

        .slack-message:hover {
            background: var(--slack-hover);
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.875rem;
            color: white;
            flex-shrink: 0;
        }

        .avatar.bot {
            background: linear-gradient(135deg, #2bac76 0%, #1a8f5c 100%);
        }

        .avatar.system {
            background: linear-gradient(135deg, #e01e5a 0%, #b01848 100%);
        }

        .message-content {
            flex: 1;
            min-width: 0;
        }

        .message-header {
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
            margin-bottom: 0.125rem;
        }

        .message-author {
            font-weight: 700;
            color: var(--slack-text);
            font-size: 0.9375rem;
        }

        .message-time {
            font-size: 0.75rem;
            color: var(--slack-text-muted);
        }

        .message-badge {
            font-size: 0.6875rem;
            padding: 0.125rem 0.375rem;
            border-radius: 3px;
            font-weight: 600;
        }

        .message-badge.api { background: rgba(29, 155, 209, 0.2); color: var(--slack-link); }
        .message-badge.error { background: rgba(224, 30, 90, 0.2); color: var(--slack-red); }
        .message-badge.state { background: rgba(232, 163, 0, 0.2); color: var(--slack-yellow); }

        .message-text {
            color: var(--slack-text);
            word-wrap: break-word;
        }

        .message-text code {
            background: rgba(29, 155, 209, 0.1);
            color: var(--slack-red);
            padding: 0.125rem 0.25rem;
            border-radius: 3px;
            font-size: 0.8125rem;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        .message-text .channel {
            color: var(--slack-link);
            background: rgba(29, 155, 209, 0.1);
            padding: 0 0.125rem;
            border-radius: 3px;
        }

        /* Console section */
        .console-section {
            height: 150px;
            min-height: 100px;
            display: flex;
            flex-direction: column;
        }

        .console-output {
            flex: 1;
            overflow-y: auto;
            background: #0d1117;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 12px;
            line-height: 1.5;
            padding: 0.5rem;
        }

        .console-line {
            padding: 0.125rem 0.5rem;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .console-line.log { color: #c9d1d9; }
        .console-line.info { color: var(--slack-link); }
        .console-line.warn { color: var(--slack-yellow); }
        .console-line.error { color: var(--slack-red); }

        /* Tabs */
        .tabs {
            display: flex;
            background: var(--slack-bg);
            border-bottom: 1px solid var(--slack-border);
        }

        .tab {
            padding: 0.625rem 1rem;
            background: none;
            border: none;
            color: var(--slack-text-muted);
            cursor: pointer;
            font-size: 0.8125rem;
            font-weight: 600;
            transition: var(--transition);
            position: relative;
        }

        .tab:hover { color: var(--slack-text); }

        .tab.active {
            color: var(--slack-text);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--slack-accent);
        }

        .tab-badge {
            background: var(--slack-red);
            color: white;
            padding: 0.0625rem 0.375rem;
            border-radius: 8px;
            font-size: 0.6875rem;
            margin-left: 0.25rem;
        }

        /* Buttons */
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            font-size: 0.8125rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
        }

        .btn-primary {
            background: var(--slack-green);
            color: white;
        }

        .btn-primary:hover { background: #229c68; }

        .btn-secondary {
            background: transparent;
            color: var(--slack-text);
            border: 1px solid var(--slack-border);
        }

        .btn-secondary:hover { background: var(--slack-hover); }

        .btn-icon {
            padding: 0.375rem;
            background: none;
            border: none;
            color: var(--slack-text-muted);
            cursor: pointer;
            border-radius: 4px;
            transition: var(--transition);
        }

        .btn-icon:hover {
            background: var(--slack-hover);
            color: var(--slack-text);
        }

        /* State Panel */
        .state-panel {
            grid-column: 1 / -1;
            grid-row: 2;
            border-top: 1px solid var(--slack-border);
            max-height: 200px;
        }

        .state-panel .panel-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1px;
            background: var(--slack-border);
            padding: 0;
        }

        .state-section {
            background: var(--slack-secondary);
            padding: 0.75rem;
        }

        .state-section h4 {
            font-size: 0.75rem;
            color: var(--slack-text-muted);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .state-editor {
            width: 100%;
            min-height: 80px;
            resize: none;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 11px;
            background: var(--slack-bg);
            border: 1px solid var(--slack-border);
            border-radius: 4px;
            padding: 0.5rem;
        }

        /* Quick Templates */
        .templates {
            display: flex;
            gap: 0.375rem;
            flex-wrap: wrap;
        }

        .template-btn {
            padding: 0.25rem 0.625rem;
            background: var(--slack-bg);
            border: 1px solid var(--slack-border);
            border-radius: 16px;
            color: var(--slack-text-muted);
            font-size: 0.75rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .template-btn:hover {
            border-color: var(--slack-accent);
            color: var(--slack-text);
        }

        /* Result display */
        .result-block {
            background: var(--slack-bg);
            border: 1px solid var(--slack-border);
            border-radius: 4px;
            padding: 0.75rem;
            margin: 0.5rem 1.25rem;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
        }

        .result-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-family: 'Lato', sans-serif;
        }

        .result-status {
            padding: 0.125rem 0.5rem;
            border-radius: 3px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .result-status.success { background: rgba(43, 172, 118, 0.2); color: var(--slack-green); }
        .result-status.error { background: rgba(224, 30, 90, 0.2); color: var(--slack-red); }

        /* History items */
        .history-item {
            padding: 0.75rem 1.25rem;
            border-bottom: 1px solid var(--slack-border);
            cursor: pointer;
            transition: var(--transition);
        }

        .history-item:hover { background: var(--slack-hover); }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
        }

        .history-time { font-size: 0.75rem; color: var(--slack-text-muted); }

        .history-message {
            font-size: 0.875rem;
            color: var(--slack-text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* API Docs */
        .api-section {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--slack-border);
        }

        .api-section h4 {
            color: var(--slack-text);
            margin-bottom: 0.75rem;
            font-size: 0.9375rem;
        }

        .api-method {
            background: var(--slack-bg);
            border-radius: 4px;
            padding: 0.5rem 0.75rem;
            margin-bottom: 0.5rem;
            font-size: 0.8125rem;
        }

        .api-method code {
            color: var(--slack-link);
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.8125rem;
        }

        .api-method .desc {
            color: var(--slack-text-muted);
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        /* Empty state */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: var(--slack-text-muted);
            text-align: center;
        }

        .empty-state-icon { font-size: 2.5rem; margin-bottom: 0.75rem; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--slack-border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--slack-text-muted); }

        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 1.5rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
        }

        .toast {
            background: var(--slack-text);
            color: var(--slack-bg);
            padding: 0.75rem 1.25rem;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: toastIn 0.2s ease;
        }

        .toast.hiding { animation: toastOut 0.2s ease forwards; }

        @keyframes toastIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes toastOut {
            to { opacity: 0; transform: translateY(-10px); }
        }

        .tab-view { display: none; }
        .tab-view.active { display: flex; flex-direction: column; height: 100%; }

        @media (max-width: 1000px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto;
            }
            .code-panel { max-height: 300px; grid-column: 1; }
            .output-panel { grid-column: 1; }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <span>Handler Simulator</span>
        </div>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="validateCode()">Validate</button>
            <button class="btn btn-primary" onclick="executeHandler()">Run</button>
        </div>
    </header>

    <main class="container">
        <!-- Left Panel: Code Editor -->
        <section class="panel code-panel">
            <div class="tabs">
                <button class="tab active" data-tab="code" onclick="switchCodeTab('code')">Handler Code</button>
                <button class="tab" data-tab="api" onclick="switchCodeTab('api')">API Reference</button>
            </div>
            <div class="panel-content">
                <div class="tab-view active" id="codeView">
                    <div class="handler-select">
                        <select id="handlerSelect" onchange="loadHandler()">
                            <option value="">Load existing handler...</option>
                        </select>
                        <button class="btn-icon" onclick="refreshHandlers()" title="Refresh">Refresh</button>
                    </div>
                    <textarea class="code-editor" id="codeEditor" spellcheck="false">// Example Handler
var name = 'my-handler';
var description = 'My custom handler';
var channels = ['*'];
var priority = 100;
var enabled = true;

function handle(message) {
    console.log('Received:', message.text);

    if (message.text.includes('hello')) {
        slack.sendEphemeral(message.channel, message.user, 'Hello there!', {});
        return { handled: true };
    }

    return { handled: false };
}</textarea>
                </div>
                <div class="tab-view" id="apiView">
                    <div id="apiContainer"></div>
                </div>
            </div>
        </section>

        <!-- Right Panel: Message & Output -->
        <section class="panel output-panel">
            <!-- Message Composer at top -->
            <div class="message-composer">
                <div class="composer-fields">
                    <div class="field-group">
                        <label>Channel</label>
                        <input type="text" id="msgChannelName" value="general" placeholder="general">
                    </div>
                    <div class="field-group">
                        <label>User</label>
                        <input type="text" id="msgUser" value="U87654321" placeholder="U12345">
                    </div>
                    <div class="field-group">
                        <label>Type</label>
                        <select id="msgChannelType">
                            <option value="channel">Channel</option>
                            <option value="im">DM</option>
                        </select>
                    </div>
                </div>
                <input type="hidden" id="msgChannel" value="C12345678">
                <input type="hidden" id="msgTimestamp" value="">
                <input type="hidden" id="msgThreadTs" value="">
                <textarea class="composer-input" id="msgText" rows="2" placeholder="Write a message to test your handler...">hello world!</textarea>
                <div class="composer-actions">
                    <div class="templates">
                        <button class="template-btn" onclick="applyTemplate('tracking')">Tracking URL</button>
                        <button class="template-btn" onclick="applyTemplate('inclusive')">Inclusive lang</button>
                        <button class="template-btn" onclick="applyTemplate('thread')">Thread</button>
                        <button class="template-btn" onclick="applyTemplate('job')">Job post</button>
                    </div>
                    <button class="btn btn-primary" onclick="executeHandler()">Send Message</button>
                </div>
            </div>

            <!-- Output content area -->
            <div class="output-content">
                <!-- Messages/Output section -->
                <div class="output-section">
                    <div class="section-header">
                        <span>Output</span>
                        <div style="display:flex;gap:0.5rem">
                            <button class="btn-icon" onclick="switchOutputTab('messages')" title="Messages">Messages</button>
                            <button class="btn-icon" onclick="switchOutputTab('history')" title="History">History <span id="historyCount">0</span></button>
                            <button class="btn-icon" onclick="clearOutput()" title="Clear">Clear</button>
                        </div>
                    </div>
                    <div class="tab-view active" id="messagesOutputView">
                        <div class="messages-container" id="messagesContainer"></div>
                    </div>
                    <div class="tab-view" id="historyOutputView">
                        <div class="messages-container" id="historyContainer"></div>
                    </div>
                </div>

                <!-- Console section -->
                <div class="console-section">
                    <div class="section-header">
                        <span>Console</span>
                        <button class="btn-icon" onclick="clearConsole()" title="Clear console">Clear</button>
                    </div>
                    <div class="console-output" id="consoleOutput"></div>
                </div>
            </div>
        </section>

        <!-- Bottom: State Panel -->
        <section class="panel state-panel">
            <div class="panel-header">
                <span>State</span>
                <div style="display:flex;gap:0.5rem">
                    <button class="btn-icon" onclick="loadState()" title="Refresh">Refresh</button>
                    <button class="btn-icon" onclick="saveState()" title="Save">Save</button>
                    <button class="btn-icon" onclick="clearState()" title="Clear">Clear</button>
                </div>
            </div>
            <div class="panel-content">
                <div class="state-section">
                    <h4>Cache (Session) - lost on refresh</h4>
                    <textarea class="state-editor" id="cacheEditor">{}</textarea>
                </div>
                <div class="state-section">
                    <h4>Store (Persistent) - localStorage</h4>
                    <textarea class="state-editor" id="storeEditor">{}</textarea>
                </div>
            </div>
        </section>
    </main>

    <div class="toast-container" id="toastContainer"></div>

    <script>
        // State
        let handlers = [];
        let messages = [];
        let consoleLogs = [];
        let history = JSON.parse(localStorage.getItem('handlerSimHistory') || '[]');
        let cacheState = {};
        let storeState = JSON.parse(localStorage.getItem('handlerSimStore') || '{}');

        const templates = {
            tracking: { text: 'Check this out https://instagram.com/p/abc123/?igshid=xyz789', channelName: 'general' },
            inclusive: { text: 'Hey guys, can someone help me with this?', channelName: 'random' },
            thread: { text: 'Thanks for the info!', channelName: 'general', threadTs: '1234567890.123456' },
            job: { text: 'We are hiring senior engineers!', channelName: 'hiring-job-board', channel: 'C30CUFT2B' }
        };

        const apiDocs = `
            <div class="api-section">
                <h4>Slack API</h4>
                <div class="api-method"><code>slack.sendMessage(channel, text, opts)</code><div class="desc">Send message to channel</div></div>
                <div class="api-method"><code>slack.sendEphemeral(channel, user, text, opts)</code><div class="desc">Send ephemeral message</div></div>
                <div class="api-method"><code>slack.deleteMessage(channel, ts)</code><div class="desc">Delete a message</div></div>
                <div class="api-method"><code>slack.addReaction(channel, ts, emoji)</code><div class="desc">Add reaction</div></div>
                <div class="api-method"><code>slack.getUserInfo(userId)</code><div class="desc">Get user info</div></div>
                <div class="api-method"><code>slack.getChannelInfo(channelId)</code><div class="desc">Get channel info</div></div>
            </div>
            <div class="api-section">
                <h4>State API</h4>
                <div class="api-method"><code>state.cache.get(key)</code> / <code>state.store.get(key)</code><div class="desc">Get value</div></div>
                <div class="api-method"><code>state.cache.set(key, val)</code> / <code>state.store.set(key, val)</code><div class="desc">Set value</div></div>
                <div class="api-method"><code>state.cache.delete(key)</code> / <code>state.store.delete(key)</code><div class="desc">Delete key</div></div>
                <div class="api-method"><code>state.cache.keys()</code> / <code>state.store.keys()</code><div class="desc">List keys</div></div>
            </div>
            <div class="api-section">
                <h4>Message Object</h4>
                <div class="api-method">
                    <code>message.text</code> - content<br>
                    <code>message.user</code> - user ID<br>
                    <code>message.channel</code> - channel ID<br>
                    <code>message.channelName</code> - channel name<br>
                    <code>message.isThread</code> - is thread reply<br>
                    <code>message.isDM</code> - is direct message
                </div>
            </div>
        `;

        document.addEventListener('DOMContentLoaded', () => {
            refreshHandlers();
            loadState();
            updateHistoryCount();
            document.getElementById('apiContainer').innerHTML = apiDocs;
            showEmptyState();
            showEmptyConsole();
        });

        function switchCodeTab(tab) {
            document.querySelectorAll('.code-panel .tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
            document.querySelectorAll('.code-panel .tab-view').forEach(v => {
                v.classList.toggle('active', v.id === tab + 'View');
            });
        }

        function switchOutputTab(tab) {
            document.getElementById('messagesOutputView').classList.toggle('active', tab === 'messages');
            document.getElementById('historyOutputView').classList.toggle('active', tab === 'history');
            if (tab === 'history') displayHistory();
        }

        function applyTemplate(name) {
            const t = templates[name];
            if (!t) return;
            if (t.text) document.getElementById('msgText').value = t.text;
            if (t.channelName) document.getElementById('msgChannelName').value = t.channelName;
            if (t.channel) document.getElementById('msgChannel').value = t.channel;
            document.getElementById('msgThreadTs').value = t.threadTs || '';
            showToast('Template: ' + name);
        }

        async function refreshHandlers() {
            try {
                const res = await fetch('/_simulator/api/handlers');
                handlers = await res.json();
                const select = document.getElementById('handlerSelect');
                select.innerHTML = '<option value="">Load existing handler...</option>';
                handlers.forEach(h => {
                    const opt = document.createElement('option');
                    opt.value = h.filename;
                    opt.textContent = h.name + (h.enabled ? '' : ' (disabled)');
                    select.appendChild(opt);
                });
            } catch (e) {
                showToast('Failed to load handlers');
            }
        }

        function loadHandler() {
            const filename = document.getElementById('handlerSelect').value;
            if (!filename) return;
            const handler = handlers.find(h => h.filename === filename);
            if (handler) {
                document.getElementById('codeEditor').value = handler.code;
                switchCodeTab('code');
                showToast('Loaded: ' + handler.name);
            }
        }

        function buildMessage() {
            const ts = document.getElementById('msgTimestamp').value || `${Math.floor(Date.now()/1000)}.${String(Date.now()%1000000).padStart(6,'0')}`;
            const threadTs = document.getElementById('msgThreadTs').value;
            return {
                type: 'message',
                channel: document.getElementById('msgChannel').value,
                channelName: document.getElementById('msgChannelName').value,
                channelType: document.getElementById('msgChannelType').value,
                user: document.getElementById('msgUser').value,
                text: document.getElementById('msgText').value,
                timestamp: ts,
                threadTimestamp: threadTs,
                isThread: !!threadTs,
                isDM: document.getElementById('msgChannelType').value === 'im',
                botId: '',
                subType: ''
            };
        }

        function addMessage(type, author, text, extra = {}) {
            messages.push({ type, author, text, time: new Date(), ...extra });
        }

        function addConsoleLog(level, ...args) {
            const text = args.map(a => {
                if (typeof a === 'object') {
                    try { return JSON.stringify(a); } catch { return String(a); }
                }
                return String(a);
            }).join(' ');
            consoleLogs.push({ level, text, time: new Date() });
        }

        function createMockAPIs(handlerName) {
            return {
                console: {
                    log: (...args) => addConsoleLog('log', ...args),
                    info: (...args) => addConsoleLog('info', ...args),
                    warn: (...args) => addConsoleLog('warn', ...args),
                    error: (...args) => addConsoleLog('error', ...args),
                },
                slack: {
                    sendMessage: (channel, text, opts) => {
                        addMessage('slack', 'Bot', text, { action: 'sendMessage', channel });
                        return { channel, timestamp: `${Date.now()/1000}` };
                    },
                    sendEphemeral: (channel, user, text, opts) => {
                        addMessage('slack', 'Bot', `[ephemeral] ${text}`, { action: 'ephemeral', user });
                    },
                    addReaction: (channel, ts, emoji) => addMessage('slack', 'Bot', `Added :${emoji}: reaction`, { action: 'reaction' }),
                    deleteMessage: (channel, ts) => addMessage('slack', 'Bot', `Deleted message`, { action: 'delete' }),
                    getUserInfo: (userId) => {
                        addMessage('api', 'API', `getUserInfo(${userId})`, { action: 'api' });
                        return { id: userId, name: 'testuser', realName: 'Test User', isBot: false };
                    },
                    getChannelInfo: (channelId) => {
                        addMessage('api', 'API', `getChannelInfo(${channelId})`, { action: 'api' });
                        return { id: channelId, name: 'test-channel', isPrivate: false };
                    }
                },
                http: {
                    get: (url) => { addMessage('api', 'HTTP', `GET ${url}`); return { status: 200, body: '{}' }; },
                    post: (url) => { addMessage('api', 'HTTP', `POST ${url}`); return { status: 200, body: '{}' }; }
                },
                state: {
                    cache: {
                        get: (key) => {
                            const val = cacheState[handlerName]?.[key];
                            addConsoleLog('log', `state.cache.get("${key}") →`, val !== undefined ? JSON.stringify(val) : 'undefined');
                            return val;
                        },
                        set: (key, val) => {
                            cacheState[handlerName] = cacheState[handlerName] || {};
                            cacheState[handlerName][key] = val;
                            addConsoleLog('log', `state.cache.set("${key}",`, JSON.stringify(val) + ')');
                        },
                        delete: (key) => { delete cacheState[handlerName]?.[key]; addConsoleLog('log', `state.cache.delete("${key}")`); },
                        has: (key) => cacheState[handlerName]?.hasOwnProperty(key) || false,
                        keys: () => Object.keys(cacheState[handlerName] || {}),
                        clear: () => { cacheState[handlerName] = {}; addConsoleLog('log', 'state.cache.clear()'); }
                    },
                    store: {
                        get: (key) => {
                            const val = storeState[handlerName]?.[key];
                            addConsoleLog('log', `state.store.get("${key}") →`, val !== undefined ? JSON.stringify(val) : 'undefined');
                            return val;
                        },
                        set: (key, val) => {
                            storeState[handlerName] = storeState[handlerName] || {};
                            storeState[handlerName][key] = val;
                            localStorage.setItem('handlerSimStore', JSON.stringify(storeState));
                            addConsoleLog('log', `state.store.set("${key}",`, JSON.stringify(val) + ')');
                        },
                        delete: (key) => { delete storeState[handlerName]?.[key]; localStorage.setItem('handlerSimStore', JSON.stringify(storeState)); addConsoleLog('log', `state.store.delete("${key}")`); },
                        has: (key) => storeState[handlerName]?.hasOwnProperty(key) || false,
                        keys: () => Object.keys(storeState[handlerName] || {}),
                        clear: () => { storeState[handlerName] = {}; localStorage.setItem('handlerSimStore', JSON.stringify(storeState)); addConsoleLog('log', 'state.store.clear()'); }
                    }
                }
            };
        }

        function executeHandler() {
            const code = document.getElementById('codeEditor').value;
            const message = buildMessage();
            messages = [];
            consoleLogs = [];

            // Add the user message first
            addMessage('user', 'Test User', message.text, { channel: message.channelName });

            const start = performance.now();
            let result = null;
            let error = null;

            try {
                const apis = createMockAPIs('simulator');
                const wrappedCode = `(function(console, slack, http, state) { ${code}; return typeof handle === 'function' ? handle : null; })`;
                const handleFn = eval(wrappedCode)(apis.console, apis.slack, apis.http, apis.state);

                if (typeof handleFn !== 'function') throw new Error("Missing 'handle' function");
                result = handleFn(message);
            } catch (e) {
                error = e.message;
                addMessage('error', 'Error', e.message);
                addConsoleLog('error', e.message);
            }

            const duration = (performance.now() - start).toFixed(2);

            // Add result message
            if (!error) {
                addMessage('result', 'Handler', `Completed in ${duration}ms`, { result, success: true });
            }

            // Save to history
            history.unshift({
                id: Date.now(),
                time: new Date().toLocaleString(),
                message: message.text.substring(0, 40),
                success: !error,
                duration,
                messages: [...messages],
                consoleLogs: [...consoleLogs]
            });
            if (history.length > 30) history.pop();
            localStorage.setItem('handlerSimHistory', JSON.stringify(history));
            updateHistoryCount();

            renderMessages();
            renderConsole();
            displayHistory();
            loadState(true);  // Highlight state changes
            switchOutputTab('messages');
        }

        function validateCode() {
            const code = document.getElementById('codeEditor').value;
            messages = [];
            consoleLogs = [];

            try {
                const apis = createMockAPIs('validator');
                const wrappedCode = `(function(console,slack,http,state){${code};return{hasHandle:typeof handle==='function',name:typeof name!=='undefined'?name:null}})`;
                const check = eval(wrappedCode)(apis.console, apis.slack, apis.http, apis.state);

                if (check.hasHandle) {
                    addMessage('result', 'Validator', `Code is valid! Handler: ${check.name || 'unnamed'}`, { success: true });
                    addConsoleLog('info', 'Validation passed');
                } else {
                    addMessage('error', 'Validator', "Missing 'handle' function");
                    addConsoleLog('error', "Missing 'handle' function");
                }
            } catch (e) {
                addMessage('error', 'Validator', 'Syntax error: ' + e.message);
                addConsoleLog('error', 'Syntax error:', e.message);
            }

            renderMessages();
            renderConsole();
            switchOutputTab('messages');
        }

        function showEmptyState() {
            document.getElementById('messagesContainer').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">Output</div>
                    <div>No messages yet</div>
                    <div style="font-size:0.875rem;margin-top:0.25rem">Run a handler to see output</div>
                </div>`;
        }

        function showEmptyConsole() {
            document.getElementById('consoleOutput').innerHTML = '<div class="console-line log" style="color:var(--slack-text-muted)">Console output will appear here...</div>';
        }

        function renderMessages() {
            const container = document.getElementById('messagesContainer');
            if (messages.length === 0) { showEmptyState(); return; }

            container.innerHTML = messages.map(m => {
                const avatarClass = m.type === 'user' ? '' : m.type === 'error' ? 'system' : 'bot';
                const initial = m.author[0].toUpperCase();
                const badge = m.type === 'api' ? '<span class="message-badge api">API</span>' :
                             m.type === 'error' ? '<span class="message-badge error">ERROR</span>' :
                             m.type === 'state' ? '<span class="message-badge state">STATE</span>' : '';

                let text = escapeHtml(m.text);
                // Format channel mentions
                text = text.replace(/#([\w-]+)/g, '<span class="channel">#$1</span>');

                return `
                    <div class="slack-message">
                        <div class="avatar ${avatarClass}">${initial}</div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-author">${escapeHtml(m.author)}</span>
                                ${badge}
                                <span class="message-time">${formatTime(m.time)}</span>
                            </div>
                            <div class="message-text">${text}</div>
                            ${m.result ? `<div class="result-block"><div class="result-header"><span class="result-status success">Success</span></div><pre>${escapeHtml(JSON.stringify(m.result, null, 2))}</pre></div>` : ''}
                        </div>
                    </div>`;
            }).join('');

            container.scrollTop = container.scrollHeight;
        }

        function renderConsole() {
            const container = document.getElementById('consoleOutput');
            if (consoleLogs.length === 0) { showEmptyConsole(); return; }

            container.innerHTML = consoleLogs.map(log =>
                `<div class="console-line ${log.level}">${escapeHtml(log.text)}</div>`
            ).join('');

            container.scrollTop = container.scrollHeight;
        }

        function clearConsole() {
            consoleLogs = [];
            showEmptyConsole();
        }

        function displayHistory() {
            const container = document.getElementById('historyContainer');
            if (history.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">History</div><div>No history yet</div></div>';
                return;
            }
            container.innerHTML = history.map(h => `
                <div class="history-item" onclick="viewHistoryItem(${h.id})">
                    <div class="history-header">
                        <span class="history-time">${h.time}</span>
                        <span class="result-status ${h.success ? 'success' : 'error'}">${h.success ? 'OK' : 'ERR'} ${h.duration}ms</span>
                    </div>
                    <div class="history-message">"${escapeHtml(h.message)}..."</div>
                </div>
            `).join('');
        }

        function viewHistoryItem(id) {
            const item = history.find(h => h.id === id);
            if (!item) return;
            messages = item.messages || [];
            consoleLogs = item.consoleLogs || [];
            renderMessages();
            renderConsole();
            switchOutputTab('messages');
            showToast('Viewing: ' + item.time);
        }

        function updateHistoryCount() {
            document.getElementById('historyCount').textContent = history.length;
        }

        function clearOutput() {
            messages = [];
            consoleLogs = [];
            history = [];
            localStorage.removeItem('handlerSimHistory');
            updateHistoryCount();
            showEmptyState();
            showEmptyConsole();
            displayHistory();
            showToast('Cleared');
        }

        function loadState(highlight = false) {
            const cacheEditor = document.getElementById('cacheEditor');
            const storeEditor = document.getElementById('storeEditor');
            cacheEditor.value = JSON.stringify(cacheState, null, 2);
            storeEditor.value = JSON.stringify(storeState, null, 2);

            if (highlight && Object.keys(cacheState).length > 0) {
                // Highlight cache section to show it changed
                cacheEditor.style.borderColor = 'var(--slack-green)';
                cacheEditor.style.boxShadow = '0 0 0 2px rgba(43, 172, 118, 0.3)';
                setTimeout(() => {
                    cacheEditor.style.borderColor = '';
                    cacheEditor.style.boxShadow = '';
                }, 1500);
                // Scroll state panel into view
                document.querySelector('.state-panel').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function saveState() {
            try {
                cacheState = JSON.parse(document.getElementById('cacheEditor').value);
                storeState = JSON.parse(document.getElementById('storeEditor').value);
                localStorage.setItem('handlerSimStore', JSON.stringify(storeState));
                showToast('Saved');
            } catch (e) { showToast('Invalid JSON'); }
        }

        function clearState() {
            cacheState = {};
            storeState = {};
            localStorage.removeItem('handlerSimStore');
            loadState();
            showToast('State cleared');
        }

        function formatTime(date) {
            return new Date(date).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        }

        function showToast(message) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => { toast.classList.add('hiding'); setTimeout(() => toast.remove(), 200); }, 2000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        document.addEventListener('keydown', e => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') { e.preventDefault(); executeHandler(); }
        });

        // Initialize
        displayHistory();
    </script>
</body>
</html>
